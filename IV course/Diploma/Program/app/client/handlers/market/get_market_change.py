from datetime import datetime, timedelta
from app.client.api.instruments_client import InstrumentsApiClient
from app.client.bot.bot import bot
from telebot import types
from app.client.utils.methods import get_info_by_ticker, get_price_change_in_current_interval
from tinkoff.invest import CandleInterval
from app.client.handlers.utils.message_utils import send_or_edit_message

instruments_client = InstrumentsApiClient()


# Ğ˜Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ñ‹ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ´Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
INTERVAL_MAPPING = {
    '10 Ğ¼Ğ¸Ğ½ÑƒÑ‚': (timedelta(minutes=10), CandleInterval.CANDLE_INTERVAL_1_MIN),
    'Ñ‡Ğ°Ñ': (timedelta(hours=1), CandleInterval.CANDLE_INTERVAL_1_MIN),
    'Ğ½ĞµĞ´ĞµĞ»Ñ': (timedelta(weeks=1), CandleInterval.CANDLE_INTERVAL_DAY),
    'Ğ¼ĞµÑÑÑ†': (timedelta(days=30), CandleInterval.CANDLE_INTERVAL_WEEK),
    'Ğ³Ğ¾Ğ´': (timedelta(days=365), CandleInterval.CANDLE_INTERVAL_MONTH)
}


@bot.callback_query_handler(func=lambda call: call.data == 'get_market_change')
def get_market_change_handler(call):
    """
    ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ± Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ñ€Ñ‹Ğ½ĞºĞ°.
    
    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ Ğ¼ĞµĞ½Ñ Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ğ¼ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ğ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸.
    """
    chat_id = call.message.chat.id
    
    try:
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
        instruments = instruments_client.get_all_instruments()
        
        if not instruments:
            send_or_edit_message(chat_id, 'âŒ *ĞÑˆĞ¸Ğ±ĞºĞ°*\n\nĞ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²')
        else:
            show_interval_selection(chat_id)
    
    except Exception as e:
        send_or_edit_message(chat_id, f"âŒ *ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²*\n\n`{str(e)}`")


def show_interval_selection(chat_id):
    """
    ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ğ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸.
    
    Args:
        chat_id: ID Ñ‡Ğ°Ñ‚Ğ°
    """
    try:
        inline_keyboard = types.InlineKeyboardMarkup()
        intervals = ['10 Ğ¼Ğ¸Ğ½ÑƒÑ‚', 'Ñ‡Ğ°Ñ', 'Ğ´ĞµĞ½ÑŒ', 'Ğ½ĞµĞ´ĞµĞ»Ñ', 'Ğ¼ĞµÑÑÑ†', 'Ğ³Ğ¾Ğ´']
        buttons = [types.InlineKeyboardButton(text=interval, callback_data=f'intervals_{interval}') for interval in intervals]
        
        for button in buttons:
            inline_keyboard.add(button)
        
        send_or_edit_message(
            chat_id, 
            'ğŸ“Š *Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ñ€Ñ‹Ğ½ĞºĞ°*\n\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸:', 
            reply_markup=inline_keyboard
        )
    
    except Exception as e:
        send_or_edit_message(chat_id, f"âŒ *ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¸ Ğ¼ĞµĞ½Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ğ°*\n\n`{str(e)}`")


@bot.callback_query_handler(func=lambda call: call.data.startswith('intervals_'))
def percent_handler(call):
    """
    ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ğ° Ğ¸ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ğ¼.
    
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼Ñƒ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñƒ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    """
    chat_id = call.message.chat.id
    interval = call.data.split('_')[1]
    
    try:
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
        send_or_edit_message(chat_id, f"â³ *ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°*\n\nĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ± Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ñ€Ñ‹Ğ½ĞºĞ° Ğ·Ğ° Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» `{interval}`...")
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
        instruments = instruments_client.get_all_instruments()
        
        if instruments:
            for instrument in instruments:
                ticker = instrument.get('ticker')
                process_ticker_data(chat_id, ticker, interval)
        else:
            send_or_edit_message(chat_id, "âŒ *ĞÑˆĞ¸Ğ±ĞºĞ°*\n\nĞ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ².")
    
    except Exception as e:
        send_or_edit_message(chat_id, f"âŒ *ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ğ°*\n\n`{str(e)}`")


def process_ticker_data(chat_id, ticker, interval):
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ Ñ‚Ğ¸ĞºĞµÑ€Ñƒ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
    
    Args:
        chat_id: ID Ñ‡Ğ°Ñ‚Ğ°
        ticker: Ğ¢Ğ¸ĞºĞµÑ€ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ°
        interval: Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
    """
    try:
        info = get_info_by_ticker(ticker)
        if info is None or info.empty:
            send_or_edit_message(chat_id, f'âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ‚Ğ¸ĞºĞµÑ€Ğ° `{ticker}`')
            return
        
        figi, name, type_of = extract_ticker_info(info)
        start_time, candle_interval = get_time_interval(interval)
        
        if start_time is None:
            send_or_edit_message(chat_id, 'âŒ *ĞÑˆĞ¸Ğ±ĞºĞ°*\n\nĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸.')
            return
        
        end_time = datetime.now()
        price_change, price_change_percent, max_price, min_price, close_price = get_price_change_in_current_interval(
            figi, start_time, end_time, candle_interval
        )
        
        send_ticker_summary(chat_id, name, type_of, ticker, price_change_percent, close_price, max_price, min_price)
    
    except Exception as e:
        send_or_edit_message(chat_id, f"âŒ *ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‚Ğ¸ĞºĞµÑ€Ğ° {ticker}*\n\n`{str(e)}`")


def extract_ticker_info(info):
    """
    Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ñ‚Ğ¸ĞºĞµÑ€Ğµ Ğ¸Ğ· Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸.
    
    Args:
        info: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ğ¸ĞºĞµÑ€Ğµ
        
    Returns:
        tuple: (figi, name, type_of)
    """
    figi = info['figi'].values[0:1][0]
    name = info['name'].values[0:1][0]
    type_of = info['type'].values[0:1][0]
    return figi, name, type_of


def get_time_interval(interval):
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¸ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» ÑĞ²ĞµÑ‡Ğ¸ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°.
    
    Args:
        interval: Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
        
    Returns:
        tuple: (start_time, candle_interval)
    """
    if interval == 'Ğ´ĞµĞ½ÑŒ':
        start_time = datetime.now().replace(hour=10, minute=0, second=0)
        candle_interval = CandleInterval.CANDLE_INTERVAL_10_MIN
    elif interval in INTERVAL_MAPPING:
        timedelta_value, candle_interval = INTERVAL_MAPPING[interval]
        start_time = datetime.now() - timedelta_value
    else:
        start_time, candle_interval = None, None
    
    return start_time, candle_interval


def send_ticker_summary(chat_id, name, type_of, ticker, price_change_percent, close_price, max_price, min_price):
    """
    ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ğ¸ĞºĞµÑ€Ğµ.
    
    Args:
        chat_id: ID Ñ‡Ğ°Ñ‚Ğ°
        name: ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ°
        type_of: Ğ¢Ğ¸Ğ¿ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ°
        ticker: Ğ¢Ğ¸ĞºĞµÑ€ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ°
        price_change_percent: ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ñ†ĞµĞ½Ñ‹
        close_price: Ğ¦ĞµĞ½Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ ÑĞ²ĞµÑ‡Ğ¸
        max_price: ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ†ĞµĞ½Ğ°
        min_price: ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ†ĞµĞ½Ğ°
    """
    # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
    change_emoji = "ğŸ“ˆ" if price_change_percent > 0 else "ğŸ“‰"
    
    text = (
        f'{change_emoji} *Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ {ticker}*\n\n'
        f'ğŸ“Œ ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: `{name}`\n'
        f'ğŸ“‹ Ğ¢Ğ¸Ğ¿: `{type_of}`\n'
        f'ğŸ·ï¸ Ğ¢Ğ¸ĞºĞµÑ€: `{ticker}`\n'
        f'ğŸ“Š Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½Ñ‹: `{round(price_change_percent, 2)}%`\n'
        f'ğŸ’° Ğ¦ĞµĞ½Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ ÑĞ²ĞµÑ‡Ğ¸: `{close_price}`\n'
        f'â¬†ï¸ ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ†ĞµĞ½Ğ°: `{max_price}`\n'
        f'â¬‡ï¸ ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ†ĞµĞ½Ğ°: `{min_price}`\n'
    )
    bot.send_message(chat_id, text, parse_mode='Markdown')
